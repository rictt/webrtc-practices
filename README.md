# WebRtc Practices

## 命令工具
- mac查看端口占用：`sudo lsof -i tcp:port`
- 结束进程：`sudo kill -9 PID`

## 【一对一】大致流程

- 准备信令服务器（交换各自的信息，收集房间、用户信息）
- 用户携带用户ID和房间ID进行登录
- 查看房间在线设备
- 进行呼叫
  - 初始化本地的video显示
  - 发送call事件，通过socket转发到对应设备
  - 初始化PeerConnection实例
  - 通过pc创建offer，发送offer事件
- 被呼叫方监听到call事件，处理onCall
  - 初始化pc对象
  - 初始化被呼叫方的video显示
- 被呼叫方监听到offer事件
  - 创建answer对象，发送answer事件
- 呼叫方监听到answer
  - 设置pc对象的remoteDescription
- 双方监听各自pc对象
  - 监听ontrack事件，设置remoteVideo
  - 监听icecandidate，进行协商

## 【一对多】

  类似于老师上课，老师分享自己的屏幕给多个学生，学生不需要分享自己的屏幕；

## 【多对多】

  假设有ABCD四名在线用户，为了达到会议室的效果，就需要将ABCD的pc对象进行互连：即A和B、C、D进行pc交换；B和A、C、D进行交换；CD同理；其中AB = BC

  后续如果需要比如将分享摄像头改成分享屏幕、静音、关闭等的操作，就需要找到对应的pc，进行操作

  ### 【基于多对多的实战】基于RTC进行通讯
  - 前提
    - 多对多，首先需要找到哪些需要进行通讯，所以需要有房间的概念，用户创建/加入房间，接着基于房间找到房间里的用户，进行通话，分享屏幕等；
  - 房间的基本描述
    - 名称
    - 参与用户列表
    - 标识：初始化、通话中、已结束
    - 可以通过分享链接，加入房间进行会话
  - 功能
    - 功能一
      - 进入房间后，默认分享自己的屏幕
        - 可以设置开/关摄像头
        - 可以设置开/关麦克风
        - 可以分享某个屏幕
      - 初始化
        - 允许房主开启连线，对其余所有用户发起通话请求
      - 通话中
        - 新用户加入房间
          - 向其他在线用户进行建立连线
          - 
      - 已结束
    - 功能二
      - 上台功能，在房间的用户可以通过点击上台进行设置当前分享的主屏幕
      - 当点击上台，更新分享者ID
        - 大屏幕展示分享者的屏幕
        - 当分享者ID和当前ID一样
          - 直接设置video的流为本地localStream
        - 当不一样
          - ~~找到与之关联的pc对象，当前用户-分享用户~~
          - ~~通过pc的getReceivers获取对应的track，设置到video上~~
          - 通过userId获取对应的video对应复制给大屏幕video

## 【综合应用】多人在线会议

### 界面功能
- 首页
  - 房间列表：查看在线的房间
  - 创建房间：给用户创建一个房间，后直接进入房间
- 房间列表
  - 展示房间的id、房间名称、在线人数
  - 右侧点击创建房间
- 房间
  - 左侧：用户列表
  - 中间：主屏幕
  - 右侧：文本交流区域
- 视频
  - 允许多个屏幕分享（即摄像头 + 屏幕等）
### 流程/逻辑设计
- 房间列表
  - 每个房间有
    - 房间名称
    - 房间id
    - 房主id
    - 房间用户列表
    - 房间状态
- 用户
  - 用户名称
  - 用户id


## Janus & mediasoup

### 问题
- janus是做了什么角色？不是纯P2P么，经过janus之后感觉通话延迟变高了

## 架构

### Mesh

### SFU（Selective Forwarding Uni）

  janus下的SFU，一个房间，分两种用户，一种是订阅者subscriber，另外一种是发布者publisher;
  当用户以各自的身份加入到房间后，有不同的操作

  - publisher
    - 发布，分享自己的屏幕
    - 加入房间
  - subscriber
    - 订阅某个/全部发布者的屏幕
  - videoroom event
    - joined当加入房间成功
      - 发布自己的流，把自己的SDP发送到服务器上，createOffer
      - 找到其他publishers，进行关联（需要初始化新的handle具柄，通过类型subscriber进行关联）
        - 通过订阅后，监听remotetrack事件，设置对应的画面信息
      - ps：所谓发布订阅，其实每一个用户既是发布者也是订阅者，当加入房间时，首先是publisher，然后获取到房间内正在直播的publisher，此时去以subscriber的身份去订阅流

